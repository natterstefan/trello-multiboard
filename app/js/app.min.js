var CheckItem=function(a,b){this.checkItem=a,this.parent=b;var c=this.parent.parent,d=$("<li></li>").text(this.checkItem.name);"complete"==this.checkItem.state?($(".tasks-complete",c.view).append(d),this.parent.state.completed++):$(".tasks-incomplete",c.view).append(d),this.parent.state.total++},CheckList=function(a,b){this.checkList=a,this.parent=b,this.checkItems=[],this.state={completed:0,total:0},this.loadCheckItems()};CheckList.prototype.loadCheckItems=function(){var a=this;Trello.get("/checklists/"+this.checkList.id,function(b){for(var c=0;c<b.checkItems.length;c++)a.addCheckItem(b.checkItems[c]);var d=$("<strong></strong>").text(b.name+" ("+a.state.completed+"/"+a.state.total+")");$(".tasks-header",a.parent.view).append(d)},function(a){console.log("error loading cards",a)})},CheckList.prototype.addCheckItem=function(a){this.checkItems.push(new CheckItem(a,this))};var Card=function(a,b){this.card=a,this.parent=b,this.checkLists=[],this.view=$("#template-card").clone(),this.view.attr("id","card-"+this.card.id),console.log("card",this);var c=this.card.name.replace("#"+this.card.idShort,"").trim();$(".card-title-link",this.view).text(c),$(".card-title-link",this.view).attr("href",this.card.url),$(".card-project",this.view).text(this.parent.parent.board.name),$(".card-number",this.view).text("#"+this.card.idShort);for(var d in this.card.members)$(".card-members",this.view).append('<a href="'+this.card.members[d].url+'" target="_blank"><img src="https://trello-avatars.s3.amazonaws.com/'+this.card.members[d].avatarHash+'/50.png" alt="'+this.card.members[d].username+'" /></a>');""==this.parent.parent.config.background_color&&"undefined"==typeof this.parent.parent.config.background_color||($(this.view).css("background-color",this.parent.parent.config.background_color),$(this.view).css("background-image","none")),""==this.parent.parent.config.color&&"undefined"==typeof this.parent.parent.config.color||$(this.view).css("color",this.parent.parent.config.color),this.loadCheckLists()};Card.prototype.loadCheckLists=function(){if(0!=this.card.idChecklists.length){var a=this;Trello.get("/cards/"+this.card.id+"/checklists",function(b){for(var c=0;c<b.length;c++)b[c].name.match(a.parent.parent.config.checklists)&&a.addCheckList(b[c])},function(a){console.log("error loading cards",a)})}},Card.prototype.addCheckList=function(a){this.checkLists.push(new CheckList(a,this))},Card.prototype.render=function(a){$(a).append(this.view)};var List=function(a,b){this.list=a,this.parent=b,this.cards=[],this.loadCards()};List.prototype.loadCards=function(){var a=this;Trello.get("/lists/"+this.list.id+"/cards?members=true&member_fields=avatarHash,username,url",function(b){for(var c=0;c<b.length;c++)if(""!=a.parent.parent.member)for(var d=0;d<b[c].idMembers.length;d++)b[c].idMembers[d]==a.parent.parent.member&&a.addCard(b[c]);else a.addCard(b[c])},function(a){console.log("error loading cards",a)})},List.prototype.addCard=function(a){var b=new Card(a,this);this.cards.push(b);var c=".target-"+this.getColumn();b.render(c)},List.prototype.getColumn=function(){return this.list.name.match(this.parent.config.label_ready)?"ready":this.list.name.match(this.parent.config.label_working)?"working":this.list.name.match(this.parent.config.label_done)?"done":void console.warn("List.getColumn warning. unexpected Column",this.list)};var Board=function(a,b,c){this.board=a,this.config=b,this.parent=c,this.lists=[],this.loadBoardMembers(),this.loadLists()};Board.prototype.loadBoardMembers=function(){var a=this,b=[];a.parent.members=[],Trello.get("boards/"+this.board.id+"/members",function(a){}).success(function(c){$.each(c,function(a,c){-1==b.indexOf(c.username)&&(b[c.id]=c.username)}),b=a.sortMembers(b),a.board.members=b;for(key in b)a.parent.members[key]=b[key];a.parent.members=a.sortMembers(a.parent.members),$(".drop-member").html(""),$(".drop-member").append('<option value="0">-</option>');for(key in a.parent.members)key==a.parent.member||a.parent.members[key]==a.parent.member?$(".drop-member").append('<option value="'+key+'" selected="selected">'+a.parent.members[key],NaN):$(".drop-member").append('<option value="'+key+'">'+a.parent.members[key],NaN)})},Board.prototype.sortMembers=function(a){var b=[];for(var c in a)b.push([a[c],c]);b.sort(function(a,b){return a=a[0],b=b[0],b>a?-1:a>b?1:0}),a=[];for(var d=0;d<b.length;d++)a[b[d][1]]=b[d][0];return a},Board.prototype.loadLists=function(){var a=this;Trello.get("/boards/"+this.board.id+"/lists",function(b){console.log("board with lists found",b.length,this);for(var c=0;c<b.length;c++)(b[c].name.match(a.config.label_ready)||b[c].name.match(a.config.label_working)||b[c].name.match(a.config.label_done))&&a.addList(b[c])},function(a){console.log("error loading lists",a)})},Board.prototype.addList=function(a){this.lists.push(new List(a,this))};var App=function(a){this.config=a,this.boards=[],this.board="",this.members=[],this.member="",this.userId="",console.info("Config: ",this.config),console.info("App: ",this)};App.prototype.init=function(){this.authorize(),this.getLoggedInUser(),this.getSelectedUser(),this.loadBoards()},App.prototype.authorize=function(){Trello.authorize({type:"redirect",name:"multiboard-for-trello",scope:{read:!0,write:!1},expiration:"never"})},App.prototype.getLoggedInUser=function(){var a=this;Trello.members.get("me",function(a){}).success(function(b){$("#trello-name").html(b.username+'<span class="caret"></span>'),$("#trello-link").attr("href",b.url),$("#trello-id").html(b.id).attr("data-clipboard-text",b.id);var c=document.getElementsByTagName("base");c.length>0&&$("#trello-bookmark").attr("href",c[0].href+"member/"+b.username),a.userId=b.id})},App.prototype.loadBoards=function(){var a=this;""!=a.member&&0!=a.member||0!=a.board||""!=a.board?""==a.member&&0==a.member||0!=a.board&&""!=a.board?""!=a.member&&0!=a.member||0==a.board&&""==a.board?Trello.get("/boards/"+a.board,function(b){a.checkBoard(b)},function(a){console.log("error",a)}):Trello.get("/boards/"+a.board,function(b){a.checkBoard(b)},function(a){console.log("error",a)}):Trello.get("/member/"+a.member+"/boards",function(b){a.checkBoards(b)},function(a){console.log("error",a)}):Trello.get("/member/me/boards",function(b){a.checkBoards(b)},function(a){console.log("error",a)})},App.prototype.addBoard=function(a,b){var c=new Board(a,b,this);this.boards.push(c),$(".drop-boards option[value='0']").length<=0&&$(".drop-boards").append('<option value="0">-</option>'),$(".drop-boards option[value='"+a.id+"']").length<=0&&$(".drop-boards").append('<option value="'+a.id+'">'+a.name+"</option>")},App.prototype.checkBoard=function(a){var b=this,c=a;for(var d in b.config.boards)b.config.boards.hasOwnProperty(d)&&c.name.match(b.config.boards[d].name)&&(console.log("add board ",c.name),b.addBoard(c,b.config.boards[d]))},App.prototype.checkBoards=function(a){for(var b=this,c=!1,d=0;d<a.length;d++){var e=a[d];for(var f in b.config.boards)b.config.boards.hasOwnProperty(f)&&(c=!1,e.name.match(b.config.boards[f].name)&&(c="undefined"!=typeof b.config.membersConfig?!e.name.match(b.config.membersConfig[b.userId])||"undefined"==typeof b.config.membersConfig[b.userId]:!0,c&&(console.log("add board ",e.name),b.addBoard(e,b.config.boards[f]))))}},App.prototype.getSelectedUser=function(){for(var a=this,b=0;b<a.config.url.length;b++)"member"==a.config.url[b]&&($(".drop-member option").filter(function(){return $(this).text()==a.config.url[b+1]}).prop("selected",!0),Trello.members.get(a.config.url[b+1],function(a){}).success(function(b){a.member=b.id,$("#member-name").text(b.username)}))};